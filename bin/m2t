#!/Users/shuymn/.anyenv/envs/phpenv/shims/php
<?php

// m2t: markdown to tex (to pdf) convert script
// require: macOS, php 7.1 or later, pandoc, platex, dvipdfmx
// note: ä¸€ç•ªä¸Šã®è¡Œã¯è‡ªåˆ†ã®ç’°å¢ƒã«åˆã£ãŸphpã¸ã®pathã«æ›¸ãæ›ãˆã¦ãã ã•ã„

final class Main
{
  private const TEX_TEMPLATE = __DIR__ . '/../res/template.tex';
  private $f_full;
  private $f_name;

  // å¿…è¦ãªã‚‚ã®ãŒã‚ã‚‹ã‹ç¢ºèª
  public function valid(array $argv): bool
  {
    try {
      if (!isset($argv[1])) {
        throw new \RuntimeException('Invalid argument.');
      }

      if (preg_match('/\.md$/', $argv[1]) === 0) {
        throw new \RuntimeException('Invalid filetype. Expected markdown file.');
      }

      if (!file_exists(self::TEX_TEMPLATE)) {
        throw new \RuntimeException(self::TEX_TEMPLATE);
      }

      return true;
    } catch (\RuntimeException $e) {
      echo "Error: {$e->getMessage()}\n";
      return false;
    }
  }

  // å¿…è¦ãªã‚‚ã®ã‚’ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¸ã‚»ãƒƒãƒˆ
  public function setProps(array $argv): Main
  {
    $this->f_full = $argv[1];
    $this->f_name = str_replace('.md', '', $argv[1]);
    return $this;
  }

  // ãŸã åˆ†å‰²ã—ã¦texä¸Šã§\inputã™ã‚‹ã ã‘ã˜ã‚ƒpackageã¨ã‹ã®é–¢ä¿‚ã§ãƒ€ãƒ¡ãªã®ã§ã€åˆæˆã™ã‚‹
  public function genReport(): bool
  {
    $template = file_get_contents(self::TEX_TEMPLATE);
    if ($template === null) {
      throw new \RuntimeException(self::TEX_TEMPLATE);
    }

    $content = file_get_contents("./{$this->f_name}.tex");
    if ($content === null) {
      throw new \RuntimeException("./{$this->f_name}.tex not found.");
    }

    $report = str_replace('\\input{content}', $content, $template);

    return file_put_contents('report.tex', $report, LOCK_EX) ? true : false;
  }

  // å‡¦ç†ã®ä¸»ãªéƒ¨åˆ†
  // ä¾‹å¤–å‡¦ç†ã¯å‘¼ã³å‡ºã—å…ƒã®runãƒ¡ã‚½ãƒƒãƒ‰ã«æŠ•ã’ã¤ã‘ã‚‹
  public function execute(): void
  {
    // é—‡ã®ã‚³ãƒ¼ãƒ‰ã®å§‹ã¾ã‚Šã€‚å®Ÿè¡Œã—ãŸã„OSã®ã‚³ãƒãƒ³ãƒ‰ã‚’é †ã«æ›¸ã
    // sedã‚³ãƒãƒ³ãƒ‰ã§ç½®ãæ›ãˆã‚‹ã‚‚ã®
    // å…¨è§’ã®ã‚«ãƒ³ãƒã¨ã‚³ãƒ³ãƒ -> åŠè§’ã«ã™ã‚‹
    // vscodeã§æ—¥æœ¬èªæ‰“ã£ã¦ã‚‹ã¨æ··å…¥ã™ã‚‹åˆ¶å¾¡æ–‡å­—^H -> æ¶ˆã™
    // pandocã§å¤‰æ›ã™ã‚‹ã¨ã¤ã„ã¦ãã‚‹\label{hogehoge}ã¨ã„ã†æ–‡å­—åˆ— -> æ¶ˆã™
    $commands = [
      "cp ./{$this->f_full} ./temp.md",
      "pandoc ./temp.md -o ./temp.tex",
      "sed -e 's/ï¼Œ/,/g' -e 's/ï¼/./g' -e 's///g' -e 's///g' -e 's/\\\\label{.*}//g' ./temp.tex > ./{$this->f_name}.tex",
      "cp report.tex temp.tex",
      "platex temp.tex",
      "dvipdfmx temp.dvi",
      "cp temp.pdf report.pdf",
      "open -a Preview report.pdf",
    ];

    try {
      foreach ($commands as $key => $command) {
        exec($command . ' 2>&1', $stderr, $return);

        if ($return !== 0) {
          throw new \RuntimeException($stderr);
        }

        // cliã®å‡¦ç†ã®é–“ã«phpã®å‡¦ç†ã‚’å‰²ã‚Šè¾¼ã¾ã›ã‚‹
        // sed ã§texãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã„ã„æ„Ÿã˜ã«ã—ãŸå¾Œã€template.texã¨åˆæˆã™ã‚‹
        if ($key === 2 && !$this->genReport()) {
          throw new \RuntimeException('Failed to generate report.tex.');
        }
      }
    } catch (\RuntimeException $e) {
      throw $e;
    }
  }

  // å®Ÿéš›ã«å®Ÿè¡Œã™ã‚‹ã¨ãã¯ã“ã‚Œã‚’å‘¼ã³å‡ºã™
  public static function run(array $argv): void
  {
    $instance = new static;

    if (!$instance->valid($argv)) {
      return;
    }

    try {
      $instance->setProps($argv)->execute();
    } catch (\RuntimeException $e) {
      echo "Error: {$e->getMessage()}\n";
    } finally {
      // ã„ã‚‰ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã£ãŸã‚‰æ¶ˆã™
      $files = [
        'temp.md',
        'temp.tex',
        'temp.pdf',
        'temp.out',
        'temp.log',
        'temp.dvi',
        'temp.aux',
      ];

      foreach ($files as $file) {
        if (file_exists("./{$file}")) {
          exec("rm ./{$file}");
        }
      }
    }
  }
}

// fire
Main::run($argv);
